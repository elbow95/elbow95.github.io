---
layout: post
title: Linux常用操作以及基本概念
date: '2018-04-02'
categories: [Linux, Interview]
---





## 一，常用操作以及概念

### 快捷键

- Tab：命令和文件名补全
- Ctrl+C：中断正在运行的程序
- Ctrl+D：结束键盘输入（End of File，EOF）

### Help

- `--help`：指令的基本用法与选项介绍

- `man`：manual的缩写，将指令的具体信息显示出来

  当执行 `man data`时，有DATE(1)出现，其中的数字表示指令的类型，常用的数字及其类型如下：

  - 1：用户在shell环境中可以操作的指令或者可执行文件
  - 5：配置文件
  - 8：系统管理员可以使用的管理指令
  
- `info`：与man类似，但是info将文档分成一个个页面，每个页面都可以跳转

- `doc`：/usr/share/doc存放着软件的一整套说明文件

### 关机

- `who`：在关机前需要先使用who命令查看有没有其他用户在线

- `sync`：为了加快对磁盘文件的读写速度，位于内存中的文件数据不会立即同步到磁盘，因此关机前需要先进性sync同步

- `shutdown`：`shutdown [-krhc] 时间 [信息]` `-k`：不会关机，只发送警告信息给所有在线用户；`-r`：将系统服务停掉后重新启动；`-h`：将系统服务停掉后就立即关机；`-c`： 取消已经在进行的shutdown

### PATH

​		在环境变量中声明可执行文件的路径，路径之间用：分割

### SUDO

​		允许一般用户使用root可执行的命令，但是只有在/etc/sudoers配置文件中添加的用户才能使用该命令

### 包管理工具

- `RPM(RedHat Package Menager)`，YUM基于RPM，具有依赖管理和软件升级功能，`RedHat,Fedora/Centos`
- `DPKG(Debian Package)`，基于Debian操作系统的包管理工具，与RPM相似，`Ubuntu,Debian`



## 二，磁盘

### 磁盘接口

- `IDE`：接口最大133MB/s
- `SATA,Serial ATA`：使用串口的ATA接口，`SATA-II`接口速度为300MB/s，`SATA-III`接口速度为600MB/s
- `SCSI,Small Computer System Interface`，小型机系统接口，多用于工作站服务器
- `NVME`

### 磁盘文件名

​		Linux中把每个硬件都当作一个文件，包括磁盘。磁盘以磁盘接口类型进行命名：

- IDE磁盘：`/dev/hd[a-d]`

- SATA/SCSI/SAS磁盘：`/dev/sd[a-p]`

  后面序号的确定与系统检测到磁盘的顺序有关，与插槽为止无关

## 三，分区

### MBR

- MBR中，第一个扇区最重要，里面有主要开机记录（Master Boot Record）及分区表（Partition Table），其中主要开机记录占用446bytes，分区表占用64bytes。
- Linux也把分区当作文件，分区文件的命名方式为：磁盘文件名+编号，例如`/dev/sda1`，逻辑分区的编号从5开始

### GPT

- 扇区是磁盘最小存储单元，现在磁盘扇区大小支持4K，GPT为了兼容所有磁盘，在扇区上使用LBA，默认大小为512bytes
- GPT第1个区块记录了主要开机记录（MBR），紧接着是33个区块记录分区信息，并把最后的33个区块用于对分区信息进行备份。
- GPT没有扩展分区概念，多是主分区，每个LBA可以分4个分区，因此最多可以分4*32个分区。

### 开机检测程序

- `BIOS`：基本输入输出系统，是一个固件（嵌入到硬件中的软件），存放在断电后内容不会丢失的只读内存中。
  - bios是开机时计算机执行的第一个程序，这个程序知道开机的磁盘，并读取磁盘第一个扇区的主要开机记录MBR，由其执行开机管理程序，这个开机管理程序回家再操作系统的核心文件
  - MBR中的开机管理程序提供以下功能：选单、载入核心文件以及转交其他开机管理程序。转交这个记录可以用来实现多重引导，只需要将另一个操作系统的开机管理程序安装在其他分区的启动扇区上，这样就可以选择操作系统。
- `UEFI`：BIOS不可以读取GPT分区表，UEFI可以



## 四，文件系统

### 分区或文件系统

- 对分区进行格式化是为了在分区上建立文件系统。一个分区通常只能格式化为一个文件系统，但是磁盘阵列等技术可以将一个分区格式化为多个文件系统。

### 组成

- `inode`：一个文件占用一个inode，记录文件的属性，同时记录此文件的内容所在的block编号；
- `block`：记录文件的内容，文件太大时，会占用多个block
- `superblock`：记录文件系统你个的整体信息，包括inode和block的总量，使用量和剩余量，以及文件系统的格式及相关信息等；
- `block bitmap`：记录block是否被使用的位图

![img](..\assets\post\2018-04-02\BSD_disk.png)

### 文件读取

- 对于Ext2文件系统，当读取一个文件内容，现在inode中查找文件所在的所有block，然后把所有block的内容读取出来
- 对于FAT文件系统，他没有inode，每个block中存储着下一个block的编号

### 磁盘碎片

- 只一个文件内容所在的block过于分散，导致磁头移动距离过大，从而降低磁盘读写性能

### block

- 在Ext2文件系统中所支持的block大小有1k，2k和4k三种，不同的的撒小限制了单个文件和文件系统的最大大小
- 一个block只能被一个文件所使用，未使用的部分直接浪费了，因此如果需要存储大量的小文件，那么最好选用小的block

### inode

- 含有以下信息：
  - 权限（read/write/excute）
  - 拥有者与群组（owner/group）
  - 容量
  - 建立或状态改变的时间（ctime）
  - 最近读取记录（atime）
  - 最近修改记录（mtime）
  - 定义文件特性的旗标（flag），比如SetUID
  - 该文件真正内容的指向（pointer）

- 有以下特点
  - 每个inode大小均固定为128bytes
  - 每个文件都仅会占用一个inode
- 一个inode大小有限，但是一个文件可能占用很多block，inode无法直接引用这么多的block，因此引入了间接，双间接，三间接引用

<div class="image-wrapper" style="text-align: center">
<img src="..\assets\post\2018-04-02\inode_with_signatures.jpg" alt="img" style="zoom:40%;" />
</div>

### 目录

- 建立一个目录时，会分配一个inode与至少一个block，block记录的是目录下文件的inode编号以及文件名
- 可以看到文件的inode本身不记录文件名，文件名记录在目录中，因此新增、删除、更改文件名这些操作和目录的权限有关

### 日志

- ext3/ext4文件系统引入了日志功能，可以利用日志来修复文件系统

### 挂载

- 挂载利用目录作为文件系统的进入点，也就是说，进入目录之后就可以读取文件系统的数据。

### 目录配置

- 为了使不同linux发行版的目录结构保持一致，FHS规定了LInux的目录结构，最基础的为：
- / (root, 根目录)
- /usr (unix software resource)：所有系统默认软件都会安装到这个目录；
- /var (variable)：存放系统或程序运行过程中的数据文件。

<div class="image-wrapper" style="text-align: center">
    <img src="..\assets\post\2018-04-02\linux-filesystem.png" alt="img" style="zoom: 80%;" />
</div>

## 五，文件

### 文件属性

- 用户分为：文件拥有者、群组以及其他人，对不同的用户有不同的文件权限
- 使用`ll`查看一个文件时，会显示文件的信息
- 例如：`drwxr-xr-x 3 root root 17 May 6 00:14 .config`
  - `drwxr-xr-x`：文件类型以及权限，第 1 位为文件类型字段，后 9 位为文件权限字段
  - `3`：链接数
  - `root`：文件拥有者
  - `root`：所属群组
  - `17`：文件大小
  - `...`：文件最后修改的时间
- 常见的文件类型及其含义：
  - `d`：目录
  - `-`：文件
  - `l`：链接文件
- 9位的文件权限字段中，每3个为一组，共3组，每一组分别代表对文件拥有者，所属群组以及其他人的权限。
- 每组权限中的3位分别是r,w,x权限，分别代表可读，可写，可执行。
- 文件时间有以下三种：
  - `modification time(mtime)`：文件内容更新就会更新
  - `status time(ctime)`：文件的状态（权限，属性）更新就会更新
  - `access time(atime)`：读取文件就会更新

### 文件与目录的基本操作

- `ls`：列出文件或者目录的信息，，目录的信息就是其中包含的文件
  - `ls [-aAdfFhilnrRSt] file|dir`
    - `-a`：列出全部文件
    - `-d`：仅列出目录本身
    - `-l`：以长数据串行列出，包含文件的属性与权限等数据
- `cd`：更改当前目录
- `mkdir`：创建目录
  - `mkdir [-mp] 目录名称`
    - `-m`：配置目录权限
    - `-p`：递归创建目录
- `rmdir`：删除目录，目录必须为空
  - `rmdir [-p] 目录名称`
    - `-p`：递归删除目录
- `touch`：更新文件时间或者建立新文件
- `cp`：复制文件，如果源文件使两个以上，则目的文件一定是个目录才行。
  - `cp [-adfilprsu] 源地址 目的地址`
    - `-a` ：相当于 -dr --preserve=all
    - `-d` ：若来源文件为链接文件，则复制链接文件属性而非文件本身 
    - `-i` ：若目标文件已经存在时，在覆盖前会先询问 
    - `-p` ：连同文件的属性一起复制过去 
    - `-r` ：递归复制 
    - `-u` ：destination 比 source 旧才更新 destination，或 destination 不存在的情况下才复制 --preserve=all ：除了 -p 的权限相关参数外，还加入 SELinux 的属性, links, xattr 等也复制了
- `rm`：删除文件
  - `rm [-fir] 文件或目录`
- `mv`：移动文件
  - `mv [-fiu] source destination`

### 修改权限

- 可以将一组权限用数字标识，此时一组权限的3个位当作二进制数字的位，从左到右每个位的权值为4、2、1
  - `chmod [-R] xyz dirname/filename`
  - 比如`chmod 754 .bashrc`

### 默认权限

- 文件默认权限：文件默认没有可执行权限，因此为666，也就是`-rw-rw-rw`
- 目录默认权限：目录必须要能够进入，也就是必须拥有可执行权限，因此为777 ，也就是`drwxrwxrwx`
- 可以使用`umask`设置或者查看默认权限，通常以掩码的形式来标识，例如002标识其他用户的权限去除了一个2的权限，也就是写权限，因此建立新文件时默认的权限为`-rw-rw-r--`

### 链接

![img](..\assets\post\2018-04-02\1e46fd03-0cda-4d60-9b1c-0c256edaf6b2.png)

- `ln [-sf] source_filename dist_filename`
  - `-s`：默认是实体链接

- 实体链接
  - 在目录下创建一个条目，记录着文件名和inode编号，这个inode就是源文件的inode
  - 删除任意一个条目，文件还是存在，只要引用数量不为0
  - 有以下限制：不能跨越文件系统，不能队目录进行链接
- 符号链接
  - 符号链接保存着源文件所在的绝对路径，在读取时会定位到源文件上，可以理解为快捷方式
  - 当源文件被删除了，链接文件就打不开了
  - 因为记录的是路径，所以可以为目录建立符号链接

### 获取文件内容

- `cat`：取得文件内容，`cat [-AbEnTv] filename`
  - `-n`：打印出行号，连同空白行也会有行号
  - `-b`：打印出行号，不打印空白行行号
- `tac`：cat的反向操作，从最后一行开始打印
- `more`：以页为单位查看文件内容，适合查看大文件
- `less`：和more类似，但是多了一个向前翻页的功能
- `head`：取得文件的前几行，`head [-n number] filename`
- `tail`：head的反向操作

### 指令与文件搜索

- `which`：指令搜索 `which [-a] command`，`-a`表示列出所有指令而不只是第一个
- `whereis`：文件搜索，只搜索几个特定的目录，速度较快
- `locate`：文件搜索，可以用关键字或者正则表达式进行搜索
  - locate使用`/var/lib/mlocate`数据库进行搜索，他存储在内存中，并且每天更新一次，所以无法用locate搜索新建的文件，可以使用`updatedb`来立即更新数据库
  - `locate [-ir] keyword`：`-r`使用正则表达式
- `find`：文件搜索，可以使用文件的属性和权限进行搜索

## 六，压缩和打包

### 压缩文件夹

- `.Z`：使用compress压缩
- `.zip`：使用zip压缩
- `.gz`：gzip
- `.bz2`：bzip2
- `.xz`：xz
- `.tar`：tar程序打包的数据，没有经过压缩
- `.tar.gz`：经过gzip压缩
- `.tar.bz2`：经过bzip2压缩
- `.tar.xz`：经过xz压缩

## 七，Bash

可以通过shell请求内核提供服务，bash正是shell的一种

### 特性

- 命令历史
- 命令与文件补全
- 命令别名：比如`ll`就是`ls -al`的别称
- shell scripts
- 通配符：比如*

### 变量操作

- 对一个变量赋值直接使用=
- 对变量取用需要加上$，也可以以`\${}`的形式

## 八，正则表达式

### grep

- `g/re/p(globally search a regular expression and print)`使用正则表示进行全局查找并打印
- `grep [-acinv] [--color=auto] 搜寻字符串 filename`
  - -c ： 统计匹配到行的个数
  - -i ： 忽略大小写
  - -n ： 输出行号
  - -v ： 反向选择，也就是显示出没有 搜寻字符串 内容的那一行
  - --color=auto ：找到的关键字加颜色显示



## 九，进程管理

### ps

- 查看某个时间点的进程信息

- `ps aux`查看所有进程
- `ps aux | grap threadx`查看特定的进程

### pstree

- 查看进程树
- 实例：查看所有进程树`pstree -A`

### top

- 实时显示进程信息
- 实例：两秒钟刷新一次：`top -d 2`

### netstat

- 查看占用端口的进程
- 实例：查看特定端口的进程`netstat -anp  | grep port`

### 进程状态

- `R`：正在执行或者可执行，此时进程位于执行队列中
- `D`：不可中断阻塞，通常为IO阻塞
- `S`：可中断阻塞，此时进程正在等待某个事件完成
- `Z`：僵死，进程已经终止但是尚未被父进程获取信息
- `T`：结束，进程既可以被作业控制信号结束，也可能是正在被跟踪

![img](..\assets\post\2018-04-02\2bab4127-3e7d-48cc-914e-436be859fb05.png)



### SIGCHLD

- 当一个子进程改变了它的状态时（停止运行，继续运行或者退出），有两种事情会发生在父进程中：
  - 得到SIGCHLD信号
  - waitpid()或者wait()调用返回
- 其中子进程发送的SIGCHLD信号包含子进程的信息，比如进程ID，进程状态，进程使用CPU的时间等
- 在子进程退出时，他的进程描述符不会立即释放，这是为了让父进程得到子进程信息，父进程通过wait()和waitpid()来获得一个已经退出的子进程的信息。

### wait()

- `pid_t wait(int *status)`
- 父进程调用wait（）会一直阻塞，知道收到一个子进程推出的SIGCHLD信号，之后wait()函数会销毁子进程并返回。
- 如果成功，返回被收集的子进程的进程ID；如果调用进程没有子进程，调用就会失败，此时返回-1，同时errno被置为ECHILD
- 参数status 用来保存被收集的子进程退出时的一些状态，如果对这个子进程是如何死掉的毫不在意，只想把这个子进程消灭掉，可以设置这个参数为 NULL。

### waitpid()

- `pid_t waitpid(pid_t pid, int *status, int options)`
- 作用和 wait() 完全相同，但是多了两个可由用户控制的参数 pid 和 options。
- pid 参数指示一个子进程的 ID，表示只关心这个子进程退出的 SIGCHLD 信号。如果 pid=-1 时，那么和 wait() 作用相同，都是关心所有子进程退出的 SIGCHLD 信号。
- options 参数主要有 WNOHANG 和 WUNTRACED 两个选项，WNOHANG 可以使 waitpid() 调用变成非阻塞的，也就是说它会立即返回，父进程可以继续执行其它任务。

### 孤儿进程

- 一个父进程退出，而它的一个或多个子进程还在运行，那么这些子进程将成为孤儿进程。

- 孤儿进程将被 init 进程（进程号为 1）所收养，并由 init 进程对它们完成状态收集工作。
- 由于孤儿进程会被 init 进程收养，所以孤儿进程不会对系统造成危害。

### 僵尸进程

- 一个子进程的进程描述符在子进程退出时不会释放，只有当父进程通过 wait() 或 waitpid() 获取了子进程信息后才会释放。如果子进程退出，而父进程并没有调用 wait() 或 waitpid()，那么子进程的进程描述符仍然保存在系统中，这种进程称之为僵尸进程。
- 僵尸进程通过 ps 命令显示出来的状态为 Z（zombie）。
- 系统所能使用的进程号是有限的，如果产生大量僵尸进程，将因为没有可用的进程号而导致系统不能产生新的进程。
- 要消灭系统中大量的僵尸进程，只需要将其父进程杀死，此时僵尸进程就会变成孤儿进程，从而被 init 进程所收养，这样 init 进程就会释放所有的僵尸进程所占有的资源，从而结束僵尸进程。

